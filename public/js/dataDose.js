/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./src/js/dataDose.js"
/*!****************************!*\
  !*** ./src/js/dataDose.js ***!
  \****************************/
(__unused_webpack___webpack_module__, __webpack_exports__, __webpack_require__) {

eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _utils_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./utils.js */ \"./src/js/utils.js\");\n\n\n(function() {\n    const inputUnidades = document.querySelector('#unidadesPorPaquete');\n    const contenedor = document.querySelector('#contenedor-productos');\n\n    /* ==========================================\n       1. ALGORITMO DE KITTING PROPORCIONAL\n       ========================================== */\n    const calcularKitting = (productos, capacidad) => {\n        let stock = { ...productos };\n        let totalUnidades = Object.values(stock).reduce((a, b) => a + b, 0);\n        let numPacksCompletos = Math.floor(totalUnidades / capacidad);\n        let planEmpaque = [];\n\n        for (let i = 0; i < numPacksCompletos; i++) {\n            let bolsa = {};\n            let totalEnBolsa = 0;\n            let stockRestanteBolsa = Object.values(stock).reduce((a, b) => a + b, 0);\n\n            Object.keys(stock).forEach(sku => {\n                let proporcion = stock[sku] / stockRestanteBolsa;\n                let asignacion = Math.floor(proporcion * capacidad);\n                asignacion = Math.min(asignacion, stock[sku]);\n                bolsa[sku] = asignacion;\n                totalEnBolsa += asignacion;\n                stock[sku] -= asignacion;\n            });\n\n            while (totalEnBolsa < capacidad) {\n                let skuPrioridad = Object.keys(stock).reduce((a, b) => stock[a] > stock[b] ? a : b);\n                if (stock[skuPrioridad] > 0) {\n                    bolsa[skuPrioridad]++;\n                    stock[skuPrioridad]--;\n                    totalEnBolsa++;\n                } else break;\n            }\n            planEmpaque.push(bolsa);\n        }\n\n        const agruparConfiguraciones = (packs) => {\n            const grupos = {};\n            packs.forEach(p => {\n                const key = JSON.stringify(Object.fromEntries(Object.entries(p).sort()));\n                grupos[key] = (grupos[key] || 0) + 1;\n            });\n            return Object.entries(grupos).map(([config, cantidad]) => ({\n                cantidad,\n                detalle: JSON.parse(config)\n            }));\n        };\n\n        return {\n            packs: agruparConfiguraciones(planEmpaque),\n            residuo: Object.fromEntries(Object.entries(stock).filter(([_, v]) => v > 0))\n        };\n    };\n\n    /* ==========================================\n       2. GESTI칍N DE CAPACIDAD (Doble Clic)\n       ========================================== */\n    inputUnidades.addEventListener('dblclick', function() {\n        this.readOnly = false;\n        this.classList.remove('bg-gray-100', 'cursor-not-allowed', 'opacity-75');\n        this.classList.add('bg-white', 'border-blue-500');\n        this.focus();\n    });\n\n    inputUnidades.addEventListener('blur', function() {\n        let valor = parseInt(this.value);\n        if (valor > 36 || valor <= 0 || isNaN(valor)) this.value = 12;\n        this.readOnly = true;\n        this.classList.add('bg-gray-100', 'cursor-not-allowed', 'opacity-75');\n        this.classList.remove('bg-white', 'border-blue-500');\n        actualizarTodo();\n    });\n\n    /* ==========================================\n       3. GESTI칍N DE FILAS Y EVENTOS\n       ========================================== */\n    document.addEventListener('click', (e) => {\n        if (e.target.closest('.addMore')) {\n            const filasActuales = document.querySelectorAll('.fila-producto').length;\n            if (filasActuales >= parseInt(inputUnidades.value)) return Swal.fire('L칤mite alcanzado', '', 'warning');\n            \n            const nuevaFila = document.querySelector('.fila-producto').cloneNode(true);\n            nuevaFila.querySelectorAll('input').forEach(i => i.value = '');\n            nuevaFila.querySelector('.btn-remove-row').classList.remove('hidden');\n            contenedor.appendChild(nuevaFila);\n            nuevaFila.querySelector('.sku-input').focus();\n            actualizarTodo();\n        }\n\n        if (e.target.closest('.btn-remove-row')) {\n            if (document.querySelectorAll('.fila-producto').length > 1) {\n                e.target.closest('.fila-producto').remove();\n                actualizarTodo();\n            }\n        }\n    });\n\n    /* ==========================================\n   3. ESCUCHA GLOBAL DE EVENTOS (Separados)\n   ========================================== */\n\n// Listener para cambios de texto y c치lculos inmediatos\ndocument.addEventListener('input', (e) => {\n    if (e.target.matches('input[name=\"valorUnidad[]\"]')) {\n        let valorPuro = e.target.value.replace(/\\D/g, \"\");\n        if (valorPuro) e.target.value = (0,_utils_js__WEBPACK_IMPORTED_MODULE_0__.formatMoney)(valorPuro);\n    }\n    \n    // Cualquier cambio en cantidad dispara el monitor y el kitting\n    if (e.target.matches('input[name=\"cantidad[]\"]') || e.target.matches('input[name=\"valorUnidad[]\"]')) {\n        actualizarTodo();\n    }\n});\n\n// Listener para el SKU: Solo cuando el usuario termina de escribir (pierde el foco)\ndocument.addEventListener('change', async (e) => {\n    if (e.target.matches('.sku-input')) {\n        const sku = e.target.value.trim();\n        const fila = e.target.closest('.fila-producto');\n        \n        if (sku.length > 0) {\n            await buscarSkuEnDB(sku, fila);\n        } else {\n            limpiarFilaDose(fila);\n            actualizarTodo();\n        }\n    }\n});\n\n    /* ==========================================\n       4. FUNCIONES DE ACTUALIZACI칍N Y UI\n       ========================================== */\n    async function buscarSkuEnDB(sku, fila) {\n    const inputNombre = fila.querySelector('input[name=\"name[]\"]');\n    const inputId = fila.querySelector('input[name=\"idProducto[]\"]');\n    const btnGuardar = document.querySelector('#guardar');\n\n    try {\n        // Bloqueo preventivo mientras busca\n        if (btnGuardar) btnGuardar.disabled = true;\n        inputNombre.placeholder = \"Verificando...\";\n\n        // Usamos ruta absoluta /json/sku/ para evitar fallos de navegaci칩n\n        const respuesta = await fetch(`../json/sku/${sku}`);\n        \n        if (respuesta.ok) {\n            const producto = await respuesta.json();\n            \n            if (producto && producto.idProducto) {\n                // 칄xito: Llenamos los datos\n                inputNombre.value = producto.nombreProducto;\n                inputId.value = producto.idProducto;\n                inputNombre.classList.remove('border-red-500', 'text-red-600');\n            } else {\n                throw new Error(\"No encontrado\");\n            }\n        } else {\n            throw new Error(\"Error servidor\");\n        }\n    } catch (error) {\n        // Error: Limpiamos campos y alertamos al operario\n        inputNombre.value = '';\n        inputId.value = '';\n        inputNombre.placeholder = \"SKU INV츼LIDO\";\n        inputNombre.classList.add('border-red-500', 'text-red-600');\n\n        Swal.fire({\n            icon: 'error',\n            title: 'SKU no registrado',\n            text: `El c칩digo \"${sku}\" no existe en el sistema del Grupo GH.`,\n            confirmButtonColor: '#3085d6',\n            timer: 2500 // Se cierra solo para no frenar tanto la operaci칩n\n        });\n    } finally {\n        // Recalculamos monitor y botones siempre al terminar la promesa\n        actualizarTodo();\n    }\n}\n\n    function limpiarFilaDose(fila) {\n        fila.querySelector('input[name=\"name[]\"]').value = '';\n        fila.querySelector('input[name=\"idProducto[]\"]').value = '';\n    }\n\n    function actualizarTodo() {\n        validarFilasCompletas();\n        actualizarMonitorDosificacion();\n        procesarYMostrarKitting();\n    }\n\n   function validarFilasCompletas() {\n    const filas = document.querySelectorAll('.fila-producto');\n    const botonesAdd = document.querySelectorAll('.addMore');\n    const btnGuardar = document.querySelector('#guardar');\n    \n    let todasOk = true;\n\n    filas.forEach(f => {\n        // Obtenemos los valores cr칤ticos de cada fila\n        const idProd = f.querySelector('input[name=\"idProducto[]\"]').value.trim();\n        const cant = f.querySelector('input[name=\"cantidad[]\"]').value.trim();\n        const valUnidad = f.querySelector('input[name=\"valorUnidad[]\"]').value.trim();\n\n        // REGLA DE ORO: Si no hay ID de producto, la fila es inv치lida\n        if (!idProd || idProd === \"\" || !cant || parseInt(cant) <= 0 || !valUnidad) {\n            todasOk = false;\n        }\n    });\n\n    // Control de botones \"Agregar M치s\" (.addMore)\n    botonesAdd.forEach(btn => {\n        btn.disabled = !todasOk;\n        if (!todasOk) {\n            btn.classList.add('opacity-50', 'cursor-not-allowed');\n            btn.title = \"Debe cargar un producto v치lido y llenar todos los campos antes de agregar otro\";\n        } else {\n            btn.classList.remove('opacity-50', 'cursor-not-allowed');\n            btn.title = \"Agregar nueva referencia\";\n        }\n    });\n\n    // Control del bot칩n de guardado final\n    if (btnGuardar) {\n        btnGuardar.disabled = !todasOk;\n        btnGuardar.classList.toggle('opacity-50', !todasOk);\n    }\n}\n\n    function actualizarMonitorDosificacion() {\n        const cap = parseInt(inputUnidades.value) || 0;\n        let total = 0;\n        document.querySelectorAll('input[name=\"cantidad[]\"]').forEach(i => total += parseInt(i.value) || 0);\n        document.querySelector('#monitorTotalProductos').innerText = total.toLocaleString();\n        document.querySelector('#monitorEstimacionPacks').innerText = Math.floor(total / (cap || 1));\n        document.querySelector('#monitorSobrantes').innerText = total % (cap || 1);\n    }\n\n    function procesarYMostrarKitting() {\n    const inputUnidades = document.querySelector('#unidadesPorPaquete');\n    const filas = document.querySelectorAll('.fila-producto');\n    const capacidad = parseInt(inputUnidades.value) || 12;\n\n    let productosParaKitting = {};\n    let mapaNombres = {}; // Objeto para guardar la relaci칩n SKU -> Nombre\n\n    filas.forEach(fila => {\n        const sku = fila.querySelector('.sku-input').value;\n        const nombre = fila.querySelector('input[name=\"name[]\"]').value; // Capturamos el nombre\n        const cantidad = parseInt(fila.querySelector('input[name=\"cantidad[]\"]').value) || 0;\n        \n        if (sku && cantidad > 0) {\n            productosParaKitting[sku] = cantidad;\n            mapaNombres[sku] = nombre; // Guardamos el nombre asociado al SKU\n        }\n    });\n\n    if (Object.keys(productosParaKitting).length === 0) return;\n\n    const resultado = calcularKitting(productosParaKitting, capacidad);\n\n    // Pasamos el mapa de nombres a la funci칩n de renderizado\n    renderizarPlanEmpaque(resultado, mapaNombres); \n}\n\n    function renderizarPlanEmpaque(resultado, mapaNombres) {\n    const contenedor = document.querySelector('#monitorPlanDetalle');\n    if (!contenedor) return;\n\n    let html = '';\n\n    // --- BLOQUE 1: LOTES COMPLETOS ---\n    resultado.packs.forEach((grupo, index) => {\n        const items = Object.entries(grupo.detalle)\n            .map(([sku, cant]) => {\n                const nombreAMostrar = mapaNombres[sku] || sku; \n                return `\n                <div class=\"flex justify-between items-center bg-white px-2 py-1 rounded border border-gray-100 text-[11px] mb-1\">\n                    <span class=\"font-medium text-gray-700 uppercase\">${nombreAMostrar}</span>\n                    <span class=\"table-badge table-badge-active\">${cant}</span>\n                </div>`;\n            }).join('');\n\n        html += `\n            <div class=\"bg-gray-50 border-l-4 border-gh-primaryHover p-4 rounded shadow-sm mb-3\">\n                <p class=\"text-xs font-bold text-gray-800 mb-2\">Lote ${index + 1}: Debes Empacar ${grupo.cantidad} bolsas con esta configuraci칩n:</p>\n                <div class=\"flex flex-col\">\n                    ${items}\n                </div>\n            </div>`;\n    });\n\n    // --- BLOQUE 2: SOBRANTES (RESIDUO) ---\n    const tieneResiduo = Object.keys(resultado.residuo).length > 0;\n    \n    if (tieneResiduo) {\n        const itemsResiduo = Object.entries(resultado.residuo)\n            .map(([sku, cant]) => {\n                const nombreAMostrar = mapaNombres[sku] || sku;\n                return `\n                <div class=\"flex justify-between items-center bg-white px-2 py-1 rounded border border-orange-100 text-[13px] mb-1\">\n                    <span class=\"font-medium  uppercase\">${nombreAMostrar}</span>\n                    <span class=\"bg-orange-100 px-2 rounded-full font-bold\">${cant}</span>\n                </div>`;\n            }).join('');\n\n        html += `\n            <div class=\"alert-error border-l-4 border-[#b982e0] p-4 rounded shadow-sm mt-4\">\n                <p class=\"text-xs font-bold mb-2\">游닍 PACK DE SALDO: Empacar 1 bolsa final con:</p>\n                <div class=\"flex flex-col\">\n                    ${itemsResiduo}\n                </div>\n                <p class=\"text-[10px] mt-2 italic\">* Esta bolsa no cumple la capacidad total (Residuo matem치tico).</p>\n            </div>`;\n    }\n\n    contenedor.innerHTML = html;\n}\n    validarFilasCompletas();\n\n\n    /* ==========================================\n   5. ENV칈O DE DATOS AL BACKEND\n   ========================================== */\nconst btnGuardar = document.querySelector('#guardar');\n\nif (btnGuardar) {\n    btnGuardar.addEventListener('click', async (e) => {\n        e.preventDefault();\n\n        // 1. Recopilar datos de las filas\n        const filas = document.querySelectorAll('.fila-producto');\n        const productos = Array.from(filas).map(f => ({\n            idProducto: f.querySelector('input[name=\"idProducto[]\"]').value,\n            cantidad: parseInt(f.querySelector('input[name=\"cantidad[]\"]').value),\n            //valorUnidad: cleanMoney(f.querySelector('input[name=\"valorUnidad[]\"]').value)\n            valorUnidad: Number((0,_utils_js__WEBPACK_IMPORTED_MODULE_0__.cleanMoney)(f.querySelector('input[name=\"valorUnidad[]\"]').value))\n        }));\n\n        const capacidadBolsa = parseInt(document.querySelector('#unidadesPorPaquete').value);\n\n        // 2. Confirmaci칩n visual antes de procesar 1.843 unidades\n        const { isConfirmed } = await Swal.fire({\n            title: '쮺onfirmar Dosificaci칩n?',\n            text: `Se generar치n aproximadamente ${Math.floor(productos.reduce((a,b) => a+b.cantidad, 0) / capacidadBolsa)} bultos.`,\n            icon: 'question',\n            showCancelButton: true,\n            confirmButtonText: 'S칤, Guardar y Generar',\n            cancelButtonText: 'Revisar'\n        });\n\n        if (!isConfirmed) return;\n\n        // 3. Bloqueo de UI y env칤o (Fetch)\n        btnGuardar.disabled = true;\n        btnGuardar.innerText = 'Procesando...';\n\n        try {\n            const inputCsrf = document.querySelector('input[name=\"_csrf\"]');\n            if (!inputCsrf) {\n                throw new Error(\"No se encontr칩 el token de seguridad CSRF\");\n            }\n            const token = inputCsrf.value;\n    \n            const respuesta = await fetch('/admin/dosificaciones/guardar', {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                    'CSRF-Token': token // O 'X-CSRF-TOKEN' dependiendo de c칩mo lo espere tu middleware\n                },\n                body: JSON.stringify({\n                    productos,\n                    capacidadBolsa\n                })\n            });\n\n            const resultado = await respuesta.json();\n\n            if (resultado.mensaje === 'ok') {\n                // El SweetAlert que planeamos para decidir qu칠 hacer despu칠s\n                Swal.fire({\n                    title: '춰Dosificaci칩n Exitosa!',\n                    text: \"쯈u칠 deseas hacer ahora?\",\n                    icon: 'success',\n                    showCancelButton: true,\n                    confirmButtonText: 'Ver Dashboard',\n                    cancelButtonText: 'Nueva Carga',\n                    allowOutsideClick: false\n                }).then((res) => {\n                    if (res.isConfirmed) {\n                        window.location.href = '/dosificaciones/dashboard';\n                    } else {\n                        window.location.reload(); \n                    }\n                });\n            } else {\n                throw new Error();\n            }\n\n        } catch (error) {\n            console.log(error)\n            Swal.fire('Error', 'No se pudo guardar la dosificaci칩n. Intenta de nuevo.', 'error');\n            btnGuardar.disabled = false;\n            btnGuardar.innerText = 'Guardar Dosificaci칩n';\n        }\n    });\n}\n})();\n\n//# sourceURL=webpack://GRUPO_GH/./src/js/dataDose.js?\n}");

/***/ },

/***/ "./src/js/utils.js"
/*!*************************!*\
  !*** ./src/js/utils.js ***!
  \*************************/
(__unused_webpack___webpack_module__, __webpack_exports__, __webpack_require__) {

eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   cleanMoney: () => (/* binding */ cleanMoney),\n/* harmony export */   formatMoney: () => (/* binding */ formatMoney)\n/* harmony export */ });\n/**\n * Formatea un n칰mero a moneda colombiana (COP)\n */\nconst formatMoney = (n, decimals = 0) => {\n    if (isNaN(n) || n === null) return \"0\";\n    return Number(n).toLocaleString('es-CO', {\n        minimumFractionDigits: decimals,\n        maximumFractionDigits: decimals\n    });\n};\n\n/**\n * Limpia un string de moneda para obtener solo el n칰mero\n * 칔til para c치lculos antes de enviar al servidor\n */\nconst cleanMoney = (str) => {\n    if (!str) return \"0\";\n    // Eliminamos el s칤mbolo de peso, los espacios y TODOS los puntos\n    return str.replace(/[$\\s.]/g, ''); \n};\n\n\n\n//# sourceURL=webpack://GRUPO_GH/./src/js/utils.js?\n}");

/***/ }

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Check if module exists (development only)
/******/ 		if (__webpack_modules__[moduleId] === undefined) {
/******/ 			var e = new Error("Cannot find module '" + moduleId + "'");
/******/ 			e.code = 'MODULE_NOT_FOUND';
/******/ 			throw e;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = __webpack_require__("./src/js/dataDose.js");
/******/ 	
/******/ })()
;